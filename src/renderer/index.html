<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://*.supabase.co wss://*.livekit.cloud; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.supabase.co wss://*.supabase.co wss://*.livekit.cloud https://*.livekit.cloud; media-src 'self' blob:; img-src 'self' data: blob:;">
  <title>Toy Chat</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Auth Screen -->
  <div id="auth-screen" class="screen active">
    <div class="auth-container">
      <div class="auth-header">
        <h1 class="auth-logo">TOY</h1>
        <p class="auth-tagline">Enter the realm of the steppe</p>
      </div>
      
      <!-- Auth Tabs -->
      <div class="auth-tabs">
        <button class="auth-tab active" data-tab="login">Sign In</button>
        <button class="auth-tab" data-tab="signup">Sign Up</button>
      </div>
      
      <!-- Login Form -->
      <form id="login-form" class="auth-form active">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" placeholder="your@email.com" required>
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
        </div>
        <button type="submit" class="auth-submit-btn">Sign In</button>
        <div id="login-error" class="auth-error"></div>
      </form>
      
      <!-- Signup Form -->
      <form id="signup-form" class="auth-form">
        <div class="form-group">
          <label for="signup-username">Username</label>
          <input type="text" id="signup-username" placeholder="Choose a username" minlength="3" maxlength="20" required>
          <span class="form-hint">3-20 characters, letters and numbers only</span>
        </div>
        <div class="form-group">
          <label for="signup-email">Email</label>
          <input type="email" id="signup-email" placeholder="your@email.com" required>
        </div>
        <div class="form-group">
          <label for="signup-password">Password</label>
          <input type="password" id="signup-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" minlength="6" required>
          <span class="form-hint">At least 6 characters</span>
        </div>
        <div class="form-group">
          <label for="signup-confirm">Confirm Password</label>
          <input type="password" id="signup-confirm" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
        </div>
        <button type="submit" class="auth-submit-btn">Create Account</button>
        <div id="signup-error" class="auth-error"></div>
      </form>
      
      <div class="version-display" id="version-display">v1.0.0</div>
    </div>
  </div>

  <!-- Gathering Hub Screen (Toy MeydanÄ±) -->
  <div id="hub-screen" class="screen">
    <!-- Starry Night Background -->
    <div class="hub-stars"></div>
    <div class="hub-stars hub-stars-2"></div>
    
    <!-- Floating Toy Bubbles (Servers) -->
    <div class="hub-orbit" id="hub-orbit">
      <!-- Toy bubbles will be dynamically added here -->
    </div>
    
    <!-- Central OtaÄŸ -->
    <div class="hub-otag">
      <div class="otag-glow"></div>
      <div class="otag-body">
        <div class="otag-roof"></div>
        <div class="otag-door"></div>
      </div>
      
      <!-- Content inside the OtaÄŸ -->
      <div class="otag-content">
        <h1 class="otag-title">TOY</h1>
        <p class="otag-subtitle">Gathering Ground</p>
        
        <div class="otag-actions">
          <button type="button" id="create-toy-btn" class="otag-btn otag-btn-primary">
            <span class="otag-btn-icon">ğŸ•ï¸</span>
            <span>Create Toy</span>
          </button>
          <button type="button" id="join-toy-btn" class="otag-btn">
            <span class="otag-btn-icon">ğŸšª</span>
            <span>Join Toy</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Bottom User Bar -->
    <div class="hub-user-bar">
      <div class="hub-user-info">
        <div class="hub-avatar" id="hub-avatar">U</div>
        <span class="hub-username" id="hub-username">Username</span>
      </div>
      <div class="hub-user-actions">
        <button type="button" id="friends-btn" class="hub-icon-btn" title="Friends">ğŸ‘¥</button>
        <button type="button" id="hub-settings-btn" class="hub-icon-btn" title="Settings">âš™ï¸</button>
        <button type="button" id="hub-logout-btn" class="hub-icon-btn" title="Log Out">ğŸšª</button>
      </div>
    </div>
  </div>

  <!-- Create Toy Modal -->
  <div id="create-toy-modal" class="modal hidden">
    <div class="modal-content toy-modal">
      <div class="toy-modal-header">
        <h2>ğŸ•ï¸ Create Your Toy</h2>
        <p>A Toy is your gathering space â€” a digital otaÄŸ for your tribe.</p>
      </div>
      
      <form id="create-toy-form">
        <div class="form-group">
          <label for="toy-name">Toy Name</label>
          <input type="text" id="toy-name" placeholder="Enter a name for your Toy" maxlength="50" required>
        </div>
        
        <div class="form-group">
          <label for="toy-description">Description</label>
          <textarea id="toy-description" placeholder="What is this Toy about?" maxlength="200"></textarea>
        </div>
        
        <div class="form-group">
          <label>Toy Type</label>
          <div class="toy-type-options">
            <label class="toy-type-option">
              <input type="radio" name="toy-type" value="public" checked>
              <span class="toy-type-card">
                <span class="toy-type-icon">ğŸŒ</span>
                <span class="toy-type-name">Public</span>
                <span class="toy-type-desc">Anyone can join</span>
              </span>
            </label>
            <label class="toy-type-option">
              <input type="radio" name="toy-type" value="private">
              <span class="toy-type-card">
                <span class="toy-type-icon">ğŸ”’</span>
                <span class="toy-type-name">Private</span>
                <span class="toy-type-desc">Invite only</span>
              </span>
            </label>
          </div>
        </div>
        
        <div class="modal-buttons">
          <button type="submit" class="btn btn-primary">Create Toy</button>
          <button type="button" id="cancel-create-toy" class="btn btn-ghost">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Join Toy Modal -->
  <div id="join-toy-modal" class="modal hidden">
    <div class="modal-content toy-modal">
      <div class="toy-modal-header">
        <h2>ğŸšª Join a Toy</h2>
        <p>Enter an invite code or browse public Toys.</p>
      </div>
      
      <div class="join-toy-tabs">
        <button class="join-tab active" data-tab="code">Invite Code</button>
        <button class="join-tab" data-tab="browse">Browse</button>
      </div>
      
      <div class="join-tab-content active" data-content="code">
        <div class="form-group">
          <label for="invite-code">Invite Code</label>
          <input type="text" id="invite-code" placeholder="Enter invite code">
        </div>
        <button id="join-by-code-btn" class="btn btn-primary">Join Toy</button>
      </div>
      
      <div class="join-tab-content" data-content="browse">
        <div class="public-toys-list" id="public-toys-list">
          <p class="loading-text">Loading public Toys...</p>
        </div>
      </div>
      
      <div class="modal-buttons">
        <button type="button" id="cancel-join-toy" class="btn btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Main Chat Screen (Inside a Toy) -->
  <div id="chat-screen" class="screen">
    <div class="app-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Hidden element for JS compatibility -->
        <span id="room-name" class="hidden"></span>
        
        <!-- Room Switcher -->
        <div class="room-switcher">
          <div class="room-switcher-header">
            <span class="room-switcher-label">CHANNELS</span>
            <button id="add-room-btn" class="add-room-btn" title="Create Room">+</button>
          </div>
          <div id="room-list" class="room-list">
            <div class="room-item active" data-room="general">
              <span class="room-icon">#</span>
              <span class="room-name">general</span>
            </div>
            <div class="room-item" data-room="random">
              <span class="room-icon">#</span>
              <span class="room-name">random</span>
            </div>
            <div class="room-item" data-room="gaming">
              <span class="room-icon">#</span>
              <span class="room-name">gaming</span>
            </div>
          </div>
        </div>
        
        <div class="sidebar-divider"></div>
        
        <!-- Direct Messages -->
        <div class="dm-section">
          <div class="dm-section-header">
            <span class="dm-section-label">DIRECT MESSAGES</span>
          </div>
          <div id="dm-list" class="dm-list"></div>
        </div>
        
        <div class="sidebar-divider"></div>
        
        <div class="users-list">
          <div class="users-list-header">
            <h3>ONLINE</h3>
            <span id="user-count" class="user-count-badge">0</span>
          </div>
          <ul id="users-list"></ul>
        </div>
        
        <div class="user-info">
          <button id="profile-btn" class="user-profile-trigger" title="View Profile">
            <div class="user-avatar-small" id="user-avatar-small">U</div>
            <span id="current-user">Username</span>
          </button>
          <button id="back-to-hub-btn" class="btn btn-icon btn-ghost" title="Back to Hub">ğŸ•ï¸</button>
          <button id="logout-btn" class="btn btn-icon btn-ghost" title="Log Out">ğŸšª</button>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Voice Status Bar -->
        <div id="voice-status-bar" class="voice-status-bar">
          <div class="voice-status-info">
            <div class="voice-status-indicator"></div>
            <span class="voice-status-text">Voice Connected</span>
            <span class="voice-status-room" id="voice-room-name">/ general</span>
          </div>
          <div class="voice-status-actions">
            <button id="voice-deafen-btn" title="Deafen">ğŸ”‡</button>
            <button id="voice-disconnect-btn" title="Disconnect">ğŸ“µ</button>
          </div>
        </div>

        <!-- Video Grid -->
        <div id="video-container" class="video-container hidden">
          <div id="video-grid" class="video-grid"></div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
          <!-- Chat Header with Search -->
          <div class="chat-header">
            <div class="chat-header-info">
              <span class="chat-header-icon">#</span>
              <span class="chat-header-name">general</span>
            </div>
            <div class="chat-header-actions">
              <button id="search-toggle-btn" class="chat-header-btn" title="Search Messages">ğŸ”</button>
              <button id="pin-toggle-btn" class="chat-header-btn" title="Pinned Messages">ğŸ“Œ</button>
            </div>
          </div>
          
          <!-- Search Bar (hidden by default) -->
          <div id="search-bar" class="search-bar hidden">
            <input type="text" id="search-input" placeholder="Search messages...">
            <div class="search-results-info">
              <span id="search-results-count"></span>
              <button id="search-prev" class="search-nav-btn" title="Previous">â–²</button>
              <button id="search-next" class="search-nav-btn" title="Next">â–¼</button>
            </div>
            <button id="search-close" class="search-close-btn" title="Close">âœ•</button>
          </div>
          
          <div id="messages" class="messages"></div>
          
          <div class="message-input-container">
            <div class="emoji-picker-container">
              <button id="emoji-btn" class="emoji-btn" title="Add Emoji">ğŸ˜Š</button>
              <div id="emoji-picker" class="emoji-picker hidden">
                <div class="emoji-picker-header">
                  <button class="emoji-category-btn active" data-category="recent" title="Recent">ğŸ•</button>
                  <button class="emoji-category-btn" data-category="smileys" title="Smileys">ğŸ˜€</button>
                  <button class="emoji-category-btn" data-category="people" title="People">ğŸ‘‹</button>
                  <button class="emoji-category-btn" data-category="nature" title="Nature">ğŸŒ¿</button>
                  <button class="emoji-category-btn" data-category="food" title="Food">ğŸ•</button>
                  <button class="emoji-category-btn" data-category="activities" title="Activities">âš½</button>
                  <button class="emoji-category-btn" data-category="objects" title="Objects">ğŸ’¡</button>
                  <button class="emoji-category-btn" data-category="symbols" title="Symbols">â¤ï¸</button>
                </div>
                <div class="emoji-picker-search">
                  <input type="text" id="emoji-search" placeholder="Search emoji...">
                </div>
                <div id="emoji-grid" class="emoji-grid"></div>
              </div>
            </div>
            <button id="image-btn" class="image-btn" title="Share Image">ğŸ“·</button>
            <input type="file" id="image-input" accept="image/*" hidden>
            <input type="text" id="message-input" placeholder="Type a message...">
            <button id="send-btn" class="btn btn-primary">Send</button>
          </div>
        </div>

        <!-- Controls -->
        <div class="controls">
          <button id="mic-btn" class="control-btn" title="Toggle Microphone">
            ğŸ¤
          </button>
          <button id="camera-btn" class="control-btn" title="Toggle Camera">
            ğŸ“·
          </button>
          <button id="screen-btn" class="control-btn" title="Share Screen">
            ğŸ–¥ï¸
          </button>
          <button id="settings-btn" class="control-btn" title="Device Settings">
            âš™ï¸
          </button>
          <button id="call-btn" class="control-btn call-btn" title="Join Voice/Video">
            ğŸ“
          </button>
          <button id="hangup-btn" class="control-btn hangup-btn hidden" title="Leave Call">
            ğŸ“µ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Screen Picker Modal -->
  <div id="screen-picker-modal" class="modal hidden">
    <div class="modal-content">
      <h2>Choose what to share</h2>
      <div id="screen-sources" class="screen-sources"></div>
      <button id="cancel-screen-picker" class="modal-cancel">Cancel</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal hidden settings-modal">
    <div class="modal-content">
      <h2>âš™ï¸ Device Settings</h2>
      
      <div class="settings-tabs">
        <button class="settings-tab active" data-tab="audio">Audio</button>
        <button class="settings-tab" data-tab="video">Video</button>
        <button class="settings-tab" data-tab="appearance">Appearance</button>
      </div>
      
      <div class="settings-section active" data-section="audio">
        <div class="setting-group">
          <label>ğŸ¤ Microphone</label>
          <select id="mic-select" class="select"></select>
        </div>
        
        <div class="setting-group">
          <label>ğŸ”Š Speaker</label>
          <select id="speaker-select" class="select"></select>
        </div>
        
        <div class="setting-row">
          <div class="setting-label">
            <span>Input Volume</span>
            <small>Adjust microphone sensitivity</small>
          </div>
          <input type="range" class="volume-slider" min="0" max="100" value="80">
        </div>
        
        <div class="setting-row">
          <div class="setting-label">
            <span>Noise Suppression</span>
            <small>Reduce background noise</small>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      
      <div class="settings-section" data-section="video">
        <div class="setting-group">
          <label>ğŸ“· Camera</label>
          <select id="camera-select" class="select"></select>
        </div>
        
        <div class="setting-row">
          <div class="setting-label">
            <span>Mirror Video</span>
            <small>Flip your video horizontally</small>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="setting-row">
          <div class="setting-label">
            <span>HD Video</span>
            <small>Use higher quality (more bandwidth)</small>
          </div>
          <label class="toggle-switch">
            <input type="checkbox">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      
      <div class="settings-section" data-section="appearance">
        <div class="setting-row">
          <div class="setting-label">
            <span>Compact Mode</span>
            <small>Reduce spacing in messages</small>
          </div>
          <label class="toggle-switch">
            <input type="checkbox">
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="setting-row">
          <div class="setting-label">
            <span>Show Timestamps</span>
            <small>Display time on messages</small>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      
      <div class="modal-buttons">
        <button id="save-settings" class="btn btn-primary">Save</button>
        <button id="cancel-settings" class="btn btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

  <!-- User Profile Modal -->
  <div id="profile-modal" class="modal hidden profile-modal">
    <div class="modal-content">
      <div class="profile-header">
        <div class="profile-avatar-container">
          <div class="profile-avatar" id="profile-avatar">
            <span id="profile-initial">U</span>
          </div>
          <button class="profile-avatar-edit" title="Change Avatar">âœï¸</button>
        </div>
      </div>
      
      <div class="profile-body">
        <h2 class="profile-username" id="profile-username">Username</h2>
        <div class="profile-status-badge">
          <span class="profile-status-dot online"></span>
          <span>Online</span>
        </div>
        
        <div class="profile-stats">
          <div class="profile-stat">
            <span class="profile-stat-value" id="profile-messages">0</span>
            <span class="profile-stat-label">Messages</span>
          </div>
          <div class="profile-stat">
            <span class="profile-stat-value" id="profile-calls">0</span>
            <span class="profile-stat-label">Calls</span>
          </div>
          <div class="profile-stat">
            <span class="profile-stat-value" id="profile-rooms">1</span>
            <span class="profile-stat-label">Rooms</span>
          </div>
        </div>
        
        <div class="profile-info">
          <div class="profile-info-item">
            <div class="profile-info-icon">ğŸ“…</div>
            <div class="profile-info-content">
              <div class="profile-info-label">Joined</div>
              <div class="profile-info-value" id="profile-joined">Today</div>
            </div>
          </div>
          <div class="profile-info-item">
            <div class="profile-info-icon">ğŸ </div>
            <div class="profile-info-content">
              <div class="profile-info-label">Current Room</div>
              <div class="profile-info-value" id="profile-room">general</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="profile-actions">
        <button class="btn btn-secondary" id="edit-profile-btn">Edit Profile</button>
        <button class="btn btn-ghost" id="close-profile-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast Notifications Container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Load dependencies from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/livekit-client@1.15.4/dist/livekit-client.umd.min.js"></script>
  <script src="app.js"></script>
</body>
</html>
